{% extends 'base.html' %}
{% load static %}

{% block title %}Satellite Orbital Parameter Comparison{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2><i class="fas fa-satellite"></i> Indian Satellite Orbital Parameter Comparison</h2>
    <p class="text-muted">Compare orbital parameters of Indian satellites</p>

    <!-- Satellite Selection -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-list-check"></i> Select Satellites to Compare</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Filter by Satellite Type:</label>
                    <select id="satelliteTypeFilter" class="form-select">
                        <option value="">All Types</option>
                        <option value="CARTOSAT">CARTOSAT Series</option>
                        <option value="RESOURCESAT">RESOURCESAT Series</option>
                        <option value="RISAT">RISAT Series</option>
                        <option value="OCEANSAT">OCEANSAT Series</option>
                        <option value="INSAT">INSAT Series</option>
                        <option value="GSAT">GSAT Series</option>
                        <option value="IRNSS">IRNSS/NavIC Series</option>
                        <option value="EOS">EOS Series</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <label class="form-label">Select Satellites (up to 10):</label>
                    <div id="satelliteCheckboxes" class="border p-3" style="max-height: 400px; overflow-y: auto;">
                        <!-- Checkboxes will be populated here -->
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-12">
                    <button id="compareBtn" class="btn btn-primary btn-lg">
                        <i class="fas fa-chart-bar"></i> Compare Selected Satellites
                    </button>
                    <button id="clearBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Clear Selection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Results -->
    <div id="comparisonResults" style="display: none;">
        <!-- Summary Stats -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Comparison Summary</h5>
            </div>
            <div class="card-body">
                <div id="summaryStats"></div>
            </div>
        </div>

        <!-- Detailed Comparison Table -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-table"></i> Orbital Parameters</h5>
            </div>
            <div class="card-body table-responsive">
                <table id="comparisonTable" class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Parameter</th>
                            <th id="tableHeaders"></th>
                        </tr>
                    </thead>
                    <tbody id="comparisonTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Visual Charts -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6>Altitude Comparison (km)</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="altitudeChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6>Orbital Period Comparison (min)</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="periodChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6>Inclination Comparison (degrees)</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="inclinationChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6>Orbit Type Distribution</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="orbitTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Options -->
        <div class="card mb-4">
            <div class="card-body">
                <button id="exportCSV" class="btn btn-success">
                    <i class="fas fa-file-csv"></i> Export to CSV
                </button>
                <button id="exportJSON" class="btn btn-info">
                    <i class="fas fa-file-code"></i> Export to JSON
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let allSatellites = [];
let selectedSatellites = [];
let charts = {};

// Load all satellites
async function loadSatellites() {
    try {
        const response = await fetch('/api/satellites/list');
        const data = await response.json();
        allSatellites = data.satellites;
        populateCheckboxes(allSatellites);
    } catch (error) {
        console.error('Error loading satellites:', error);
    }
}

// Populate satellite checkboxes
function populateCheckboxes(satellites) {
    const container = document.getElementById('satelliteCheckboxes');
    container.innerHTML = '';
    
    satellites.forEach(sat => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input satellite-checkbox" type="checkbox" 
                   value="${sat.norad_id}" id="sat_${sat.norad_id}">
            <label class="form-check-label" for="sat_${sat.norad_id}">
                <strong>${sat.name}</strong> (ID: ${sat.norad_id}) - 
                ${sat.orbit || 'N/A'} | Alt: ${sat.perigee?.toFixed(0) || 'N/A'}-${sat.apogee?.toFixed(0) || 'N/A'} km
            </label>
        `;
        container.appendChild(div);
    });
}

// Filter satellites by type
document.getElementById('satelliteTypeFilter').addEventListener('change', function() {
    const filter = this.value.toUpperCase();
    
    if (filter === '') {
        populateCheckboxes(allSatellites);
    } else if (filter === 'OTHER') {
        const patterns = ['CARTOSAT', 'RESOURCESAT', 'RISAT', 'OCEANSAT', 'INSAT', 'GSAT', 'IRNSS', 'EOS'];
        const filtered = allSatellites.filter(sat => 
            !patterns.some(p => sat.name.toUpperCase().includes(p))
        );
        populateCheckboxes(filtered);
    } else {
        const filtered = allSatellites.filter(sat => 
            sat.name.toUpperCase().includes(filter)
        );
        populateCheckboxes(filtered);
    }
});

// Compare button click
document.getElementById('compareBtn').addEventListener('click', async function() {
    const checkboxes = document.querySelectorAll('.satellite-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Please select at least one satellite');
        return;
    }
    
    if (checkboxes.length > 10) {
        alert('Please select maximum 10 satellites for comparison');
        return;
    }
    
    const noradIds = Array.from(checkboxes).map(cb => cb.value);
    await compareSatellites(noradIds);
});

// Clear selection
document.getElementById('clearBtn').addEventListener('click', function() {
    document.querySelectorAll('.satellite-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('comparisonResults').style.display = 'none';
});

// Compare satellites
async function compareSatellites(noradIds) {
    try {
        const response = await fetch('/api/satellites/compare', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
            body: JSON.stringify({norad_ids: noradIds})
        });
        
        const data = await response.json();
        selectedSatellites = data.satellites;
        
        displayComparisonResults(data);
        createCharts(data);
        
        document.getElementById('comparisonResults').style.display = 'block';
        document.getElementById('comparisonResults').scrollIntoView({behavior: 'smooth'});
    } catch (error) {
        console.error('Error comparing satellites:', error);
        alert('Error loading comparison data');
    }
}

// Display comparison results
function displayComparisonResults(data) {
    // Summary stats
    const summary = document.getElementById('summaryStats');
    const stats = data.summary;
    summary.innerHTML = `
        <div class="row">
            <div class="col-md-3">
                <div class="alert alert-info">
                    <strong>Satellites:</strong> ${stats.count}
                </div>
            </div>
            <div class="col-md-3">
                <div class="alert alert-success">
                    <strong>Avg Altitude:</strong> ${stats.avg_altitude.toFixed(0)} km
                </div>
            </div>
            <div class="col-md-3">
                <div class="alert alert-warning">
                    <strong>Avg Period:</strong> ${stats.avg_period.toFixed(1)} min
                </div>
            </div>
            <div class="col-md-3">
                <div class="alert alert-primary">
                    <strong>Avg Inclination:</strong> ${stats.avg_inclination.toFixed(1)}°
                </div>
            </div>
        </div>
    `;
    
    // Comparison table
    const satellites = data.satellites;
    const tbody = document.getElementById('comparisonTableBody');
    const headers = document.getElementById('tableHeaders');
    
    // Create headers
    headers.innerHTML = satellites.map(s => `<th>${s.name}</th>`).join('');
    
    // Create rows
    const parameters = [
        {name: 'NORAD ID', key: 'norad_id'},
        {name: 'Orbit Type', key: 'orbit'},
        {name: 'Inclination (°)', key: 'inclination', format: v => v?.toFixed(4)},
        {name: 'Orbital Period (min)', key: 'orbital_period', format: v => v?.toFixed(2)},
        {name: 'Perigee (km)', key: 'perigee', format: v => v?.toFixed(2)},
        {name: 'Apogee (km)', key: 'apogee', format: v => v?.toFixed(2)},
        {name: 'Avg Altitude (km)', key: 'perigee', format: (v, s) => ((s.perigee + s.apogee) / 2).toFixed(2)},
        {name: 'Orbits per Day', key: 'orbits_per_day'},
        {name: 'Launch Date', key: 'launch_date'},
        {name: 'Status', key: 'status'}
    ];
    
    tbody.innerHTML = parameters.map(param => {
        const row = `
            <tr>
                <td><strong>${param.name}</strong></td>
                ${satellites.map(s => {
                    const value = param.format ? param.format(s[param.key], s) : s[param.key];
                    return `<td>${value || 'N/A'}</td>`;
                }).join('')}
            </tr>
        `;
        return row;
    }).join('');
}

// Create charts
function createCharts(data) {
    const satellites = data.satellites;
    const labels = satellites.map(s => s.name);
    
    // Destroy existing charts
    Object.values(charts).forEach(chart => chart.destroy());
    charts = {};
    
    // Altitude chart
    const altitudeCtx = document.getElementById('altitudeChart').getContext('2d');
    charts.altitude = new Chart(altitudeCtx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Perigee',
                data: satellites.map(s => s.perigee),
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }, {
                label: 'Apogee',
                data: satellites.map(s => s.apogee),
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {y: {beginAtZero: false}}
        }
    });
    
    // Period chart
    const periodCtx = document.getElementById('periodChart').getContext('2d');
    charts.period = new Chart(periodCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Orbital Period',
                data: satellites.map(s => s.orbital_period),
                borderColor: 'rgba(75, 192, 192, 1)',
                tension: 0.1,
                fill: false
            }]
        },
        options: {responsive: true}
    });
    
    // Inclination chart
    const inclinationCtx = document.getElementById('inclinationChart').getContext('2d');
    charts.inclination = new Chart(inclinationCtx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Inclination',
                data: satellites.map(s => s.inclination),
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                borderColor: 'rgba(153, 102, 255, 1)',
                pointBackgroundColor: 'rgba(153, 102, 255, 1)'
            }]
        },
        options: {responsive: true}
    });
    
    // Orbit type chart
    const orbitTypes = {};
    satellites.forEach(s => {
        orbitTypes[s.orbit] = (orbitTypes[s.orbit] || 0) + 1;
    });
    
    const orbitTypeCtx = document.getElementById('orbitTypeChart').getContext('2d');
    charts.orbitType = new Chart(orbitTypeCtx, {
        type: 'pie',
        data: {
            labels: Object.keys(orbitTypes),
            datasets: [{
                data: Object.values(orbitTypes),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 206, 86, 0.5)',
                    'rgba(75, 192, 192, 0.5)'
                ]
            }]
        },
        options: {responsive: true}
    });
}

// Export functions
document.getElementById('exportCSV').addEventListener('click', function() {
    exportToCSV(selectedSatellites);
});

document.getElementById('exportJSON').addEventListener('click', function() {
    exportToJSON(selectedSatellites);
});

function exportToCSV(satellites) {
    const headers = ['Name', 'NORAD_ID', 'Orbit_Type', 'Inclination', 'Period', 'Perigee', 'Apogee', 'Orbits_Per_Day'];
    const rows = satellites.map(s => [
        s.name, s.norad_id, s.orbit, s.inclination, s.orbital_period, s.perigee, s.apogee, s.orbits_per_day
    ]);
    
    let csv = headers.join(',') + '\n';
    csv += rows.map(row => row.join(',')).join('\n');
    
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'satellite_comparison_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
}

function exportToJSON(satellites) {
    const json = JSON.stringify(satellites, null, 2);
    const blob = new Blob([json], {type: 'application/json'});
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'satellite_comparison_' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize
loadSatellites();
</script>
{% endblock %}
