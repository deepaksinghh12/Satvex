{% extends 'base.html' %}
{% load static %}

{% block title %}TLE Change Comparison{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2><i class="fas fa-exchange-alt"></i> TLE Orbital Parameter Change Comparison</h2>
    <p class="text-muted">Compare current TLE with previous TLE to track orbital parameter changes</p>

    <!-- Satellite Selection -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-satellite"></i> Select Satellite</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Search Satellite:</label>
                    <input type="text" id="satelliteSearch" class="form-control" placeholder="Type satellite name or NORAD ID...">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Filter by Type:</label>
                    <select id="typeFilter" class="form-select">
                        <option value="">All Types</option>
                        <option value="CARTOSAT">CARTOSAT Series</option>
                        <option value="RESOURCESAT">RESOURCESAT Series</option>
                        <option value="RISAT">RISAT Series</option>
                        <option value="NISAR">NISAR</option>
                        <option value="EOS">EOS Series</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <label class="form-label">Select Satellite:</label>
                    <select id="satelliteSelect" class="form-select" size="10">
                        <!-- Options populated dynamically -->
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <button id="compareBtn" class="btn btn-primary btn-lg">
                        <i class="fas fa-chart-line"></i> Compare TLE Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading TLE comparison data...</p>
    </div>

    <!-- Comparison Results -->
    <div id="comparisonResults" style="display: none;">
        <!-- Satellite Info -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0" id="satelliteTitle"></h5>
            </div>
            <div class="card-body">
                <div id="satelliteInfo" class="row"></div>
            </div>
        </div>

        <!-- TLE Comparison Summary -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-history"></i> TLE Update Summary</h5>
            </div>
            <div class="card-body">
                <div id="tleSummary"></div>
            </div>
        </div>

        <!-- Parameter Changes Table -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-table"></i> Orbital Parameter Changes</h5>
            </div>
            <div class="card-body table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Parameter</th>
                            <th>Previous TLE</th>
                            <th>Current TLE</th>
                            <th>Change</th>
                            <th>% Change</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="changesTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Visual Comparison Charts -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6>Altitude Change (km)</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="altitudeChangeChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6>Orbital Period Change (min)</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="periodChangeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6>Inclination Change (Â°)</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="inclinationChangeChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6>Eccentricity Change</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="eccentricityChangeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- TLE History Timeline -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-timeline"></i> TLE History (Last 10 Updates)</h5>
            </div>
            <div class="card-body">
                <div id="tleHistoryTimeline"></div>
            </div>
        </div>

        <!-- Export Options -->
        <div class="card mb-4">
            <div class="card-body">
                <button id="exportComparisonCSV" class="btn btn-success">
                    <i class="fas fa-file-csv"></i> Export Comparison to CSV
                </button>
                <button id="exportComparisonJSON" class="btn btn-info">
                    <i class="fas fa-file-code"></i> Export to JSON
                </button>
                <button id="downloadReport" class="btn btn-primary">
                    <i class="fas fa-file-pdf"></i> Generate Report
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let allSatellites = [];
let currentComparison = null;
let charts = {};

// Load satellites
async function loadSatellites() {
    try {
        const response = await fetch('/api/satellites/list');
        const data = await response.json();
        allSatellites = data.satellites;
        populateSatelliteSelect(allSatellites);
    } catch (error) {
        console.error('Error loading satellites:', error);
    }
}

// Populate satellite dropdown
function populateSatelliteSelect(satellites) {
    const select = document.getElementById('satelliteSelect');
    select.innerHTML = '';
    
    satellites.forEach(sat => {
        const option = document.createElement('option');
        option.value = sat.norad_id;
        option.textContent = `${sat.name} (ID: ${sat.norad_id}) - ${sat.orbit || 'N/A'}`;
        select.appendChild(option);
    });
}

// Search filter
document.getElementById('satelliteSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const filtered = allSatellites.filter(sat => 
        sat.name.toLowerCase().includes(searchTerm) || 
        sat.norad_id.toString().includes(searchTerm)
    );
    populateSatelliteSelect(filtered);
});

// Type filter
document.getElementById('typeFilter').addEventListener('change', function() {
    const filter = this.value.toUpperCase();
    
    if (filter === '') {
        populateSatelliteSelect(allSatellites);
    } else {
        const filtered = allSatellites.filter(sat => 
            sat.name.toUpperCase().includes(filter)
        );
        populateSatelliteSelect(filtered);
    }
});

// Compare button
document.getElementById('compareBtn').addEventListener('click', async function() {
    const select = document.getElementById('satelliteSelect');
    const noradId = select.value;
    
    if (!noradId) {
        alert('Please select a satellite');
        return;
    }
    
    await compareTLEChanges(noradId);
});

// Compare TLE changes
async function compareTLEChanges(noradId) {
    document.getElementById('loadingIndicator').style.display = 'block';
    document.getElementById('comparisonResults').style.display = 'none';
    
    try {
        const response = await fetch(`/api/satellites/${noradId}/tle-comparison`);
        const data = await response.json();
        
        if (data.error) {
            alert(data.error);
            document.getElementById('loadingIndicator').style.display = 'none';
            return;
        }
        
        currentComparison = data;
        displayComparison(data);
        createComparisonCharts(data);
        
        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('comparisonResults').style.display = 'block';
        document.getElementById('comparisonResults').scrollIntoView({behavior: 'smooth'});
    } catch (error) {
        console.error('Error:', error);
        alert('Error loading comparison data');
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

// Display comparison results
function displayComparison(data) {
    // Satellite title
    document.getElementById('satelliteTitle').textContent = 
        `${data.satellite.name} (NORAD ID: ${data.satellite.norad_id})`;
    
    // Satellite info
    const info = document.getElementById('satelliteInfo');
    info.innerHTML = `
        <div class="col-md-3">
            <strong>Type:</strong> ${data.satellite.satellite_type || 'N/A'}
        </div>
        <div class="col-md-3">
            <strong>Orbit:</strong> ${data.satellite.orbit || 'N/A'}
        </div>
        <div class="col-md-3">
            <strong>Launch Date:</strong> ${data.satellite.launch_date || 'N/A'}
        </div>
        <div class="col-md-3">
            <strong>Status:</strong> <span class="badge bg-success">${data.satellite.status || 'Active'}</span>
        </div>
    `;
    
    // TLE summary
    const summary = document.getElementById('tleSummary');
    const daysDiff = data.days_between_updates;
    const alertClass = daysDiff > 7 ? 'alert-warning' : daysDiff > 30 ? 'alert-danger' : 'alert-success';
    
    summary.innerHTML = `
        <div class="row">
            <div class="col-md-3">
                <div class="alert alert-info">
                    <strong>Current TLE Date:</strong><br>
                    ${data.current_tle.epoch_date}
                </div>
            </div>
            <div class="col-md-3">
                <div class="alert alert-secondary">
                    <strong>Previous TLE Date:</strong><br>
                    ${data.previous_tle.epoch_date}
                </div>
            </div>
            <div class="col-md-3">
                <div class="alert ${alertClass}">
                    <strong>Days Between Updates:</strong><br>
                    ${daysDiff.toFixed(1)} days
                </div>
            </div>
            <div class="col-md-3">
                <div class="alert alert-primary">
                    <strong>Total TLE Records:</strong><br>
                    ${data.total_tle_count}
                </div>
            </div>
        </div>
    `;
    
    // Changes table
    const tbody = document.getElementById('changesTableBody');
    const changes = data.changes;
    
    tbody.innerHTML = Object.keys(changes).map(param => {
        const change = changes[param];
        const statusClass = Math.abs(change.percent_change) > 1 ? 'bg-warning' : 
                           Math.abs(change.percent_change) > 0.1 ? 'bg-info' : 'bg-success';
        const statusText = Math.abs(change.percent_change) > 1 ? 'Significant' : 
                          Math.abs(change.percent_change) > 0.1 ? 'Moderate' : 'Minimal';
        
        return `
            <tr>
                <td><strong>${param}</strong></td>
                <td>${change.previous?.toFixed(6) || 'N/A'}</td>
                <td>${change.current?.toFixed(6) || 'N/A'}</td>
                <td>${change.absolute_change >= 0 ? '+' : ''}${change.absolute_change?.toFixed(6) || 'N/A'}</td>
                <td>${change.percent_change >= 0 ? '+' : ''}${change.percent_change?.toFixed(4) || 'N/A'}%</td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
            </tr>
        `;
    }).join('');
    
    // TLE History Timeline
    displayTLEHistory(data.tle_history);
}

// Display TLE history timeline
function displayTLEHistory(history) {
    const timeline = document.getElementById('tleHistoryTimeline');
    
    timeline.innerHTML = `
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Epoch Date</th>
                        <th>Inclination</th>
                        <th>Period (min)</th>
                        <th>Perigee (km)</th>
                        <th>Apogee (km)</th>
                    </tr>
                </thead>
                <tbody>
                    ${history.map((tle, index) => `
                        <tr class="${index === 0 ? 'table-primary' : ''}">
                            <td>${index + 1}${index === 0 ? ' (Current)' : ''}</td>
                            <td>${tle.epoch_date}</td>
                            <td>${tle.inclination?.toFixed(4) || 'N/A'}</td>
                            <td>${tle.period?.toFixed(2) || 'N/A'}</td>
                            <td>${tle.perigee?.toFixed(2) || 'N/A'}</td>
                            <td>${tle.apogee?.toFixed(2) || 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// Create comparison charts
function createComparisonCharts(data) {
    // Destroy existing charts
    Object.values(charts).forEach(chart => chart.destroy());
    charts = {};
    
    const changes = data.changes;
    
    // Altitude change chart
    const altCtx = document.getElementById('altitudeChangeChart').getContext('2d');
    charts.altitude = new Chart(altCtx, {
        type: 'bar',
        data: {
            labels: ['Perigee', 'Apogee'],
            datasets: [{
                label: 'Previous',
                data: [changes.Perigee.previous, changes.Apogee.previous],
                backgroundColor: 'rgba(54, 162, 235, 0.5)'
            }, {
                label: 'Current',
                data: [changes.Perigee.current, changes.Apogee.current],
                backgroundColor: 'rgba(255, 99, 132, 0.5)'
            }]
        },
        options: {responsive: true}
    });
    
    // Period change chart
    const periodCtx = document.getElementById('periodChangeChart').getContext('2d');
    charts.period = new Chart(periodCtx, {
        type: 'bar',
        data: {
            labels: ['Orbital Period'],
            datasets: [{
                label: 'Previous',
                data: [changes['Orbital Period'].previous],
                backgroundColor: 'rgba(75, 192, 192, 0.5)'
            }, {
                label: 'Current',
                data: [changes['Orbital Period'].current],
                backgroundColor: 'rgba(153, 102, 255, 0.5)'
            }]
        },
        options: {responsive: true}
    });
    
    // Inclination change chart
    const inclCtx = document.getElementById('inclinationChangeChart').getContext('2d');
    charts.inclination = new Chart(inclCtx, {
        type: 'line',
        data: {
            labels: ['Previous', 'Current'],
            datasets: [{
                label: 'Inclination',
                data: [changes.Inclination.previous, changes.Inclination.current],
                borderColor: 'rgba(255, 206, 86, 1)',
                fill: false
            }]
        },
        options: {responsive: true}
    });
    
    // Eccentricity change chart
    const eccCtx = document.getElementById('eccentricityChangeChart').getContext('2d');
    charts.eccentricity = new Chart(eccCtx, {
        type: 'line',
        data: {
            labels: ['Previous', 'Current'],
            datasets: [{
                label: 'Eccentricity',
                data: [changes.Eccentricity.previous, changes.Eccentricity.current],
                borderColor: 'rgba(255, 159, 64, 1)',
                fill: false
            }]
        },
        options: {responsive: true}
    });
}

// Export functions
document.getElementById('exportComparisonCSV').addEventListener('click', function() {
    if (!currentComparison) return;
    exportTLEComparisonCSV(currentComparison);
});

document.getElementById('exportComparisonJSON').addEventListener('click', function() {
    if (!currentComparison) return;
    const json = JSON.stringify(currentComparison, null, 2);
    downloadFile(json, 'application/json', `tle_comparison_${currentComparison.satellite.norad_id}_${new Date().toISOString().split('T')[0]}.json`);
});

function exportTLEComparisonCSV(data) {
    const headers = ['Parameter', 'Previous_Value', 'Current_Value', 'Absolute_Change', 'Percent_Change'];
    const rows = Object.keys(data.changes).map(param => {
        const change = data.changes[param];
        return [param, change.previous, change.current, change.absolute_change, change.percent_change];
    });
    
    let csv = headers.join(',') + '\n';
    csv += rows.map(row => row.join(',')).join('\n');
    
    downloadFile(csv, 'text/csv', `tle_comparison_${data.satellite.norad_id}_${new Date().toISOString().split('T')[0]}.csv`);
}

function downloadFile(content, type, filename) {
    const blob = new Blob([content], {type: type});
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
}

// Initialize
loadSatellites();
</script>
{% endblock %}
